stages:
  - build

build:standard:
  stage: build
  image: php:7.0-apache
  before_script:
    - apt-get update -qq && apt-get install -y -qq zip
    - zip -v
  script:
    - if grep -rn './' -e "\xEF\xBB\xBF"; then exit 1; fi
    - grep -E -o '<version>(.*?)</version>' ./pkg_checklist_standard.xml | sed -E 's/<version>|<\/version>//g' | while read version; do find ./com_checklist_standard/admin/sql/updates/ -maxdepth 2 -name "*.sql" -print |  sed -E 's/.*\/|\.sql//g' | while read sqin; do if [ "$sqin" \> "$version" ]; then exit 1; fi; done; done
# delete updater temporary
    - sed -E -i 's/<file.*?_joomplaceupdater.zip<\/file>//g' ./pkg_com_checklist_standard.xml
    - mkdir packages
    - grep -E -o '<file.*>(.*?)</file>' ./pkg_com_checklist_standard.xml |  sed -E 's/<file[^>]+>|.zip<\/file>//g' | while read in; do if [ "$in" != 'plg_installer_joomplaceupdater' ]; then cd ./"$in"; zip -r ./../packages/"$in".zip ./*; cd ./../; fi; done
    - pwd
  artifacts:
    paths:
    - packages/
    - pkg_com_checklist_standard.xml
    name: "pkg_checklist_standard_${CI_BUILD_REF_NAME}"
    when: on_success
    expire_in: 1 day

build:professional:
  stage: build
  image: php:7.0-apache
  before_script:
    - apt-get update -qq && apt-get install -y -qq zip
    - zip -v
  script:
    - if grep -rn './' -e "\xEF\xBB\xBF"; then exit 1; fi
    - grep -E -o '<version>(.*?)</version>' ./pkg_checklist_professional.xml | sed -E 's/<version>|<\/version>//g' | while read version; do find ./com_checklist_professional/admin/sql/updates/ -maxdepth 2 -name "*.sql" -print |  sed -E 's/.*\/|\.sql//g' | while read sqin; do if [ "$sqin" \> "$version" ]; then exit 1; fi; done; done
# delete updater temporary
    - sed -E -i 's/<file.*?_joomplaceupdater.zip<\/file>//g' ./pkg_checklist_professional.xml
    - mkdir packages
    - grep -E -o '<file.*>(.*?)</file>' ./pkg_checklist_professional.xml |  sed -E 's/<file[^>]+>|.zip<\/file>//g' | while read in; do if [ "$in" != 'plg_installer_joomplaceupdater' ]; then cd ./"$in"; zip -r ./../packages/"$in".zip ./*; cd ./../; fi; done
    - pwd
  artifacts:
    paths:
    - packages/
    - pkg_checklist_professional.xml
    name: "pkg_checklist_professional_${CI_BUILD_REF_NAME}"
    when: on_success
    expire_in: 1 day
